"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ValidateBody = void 0;
// FoalTS
const core_1 = require("../../core");
const utils_1 = require("../utils");
const is_function_util_1 = require("./is-function.util");
/**
 * Hook factory validating the body of the request against a AJV schema.
 *
 * @export
 * @param {(object | ((controller: any) => object))} schema - Schema used to validate the request body.
 * @param {{ openapi?: boolean }} [options] - Options to add openapi metadata
 * @returns {HookDecorator} - The hook.
 */
function ValidateBody(schema, options) {
    let validateSchema;
    function validate(ctx, services) {
        if (!validateSchema) {
            const ajvSchema = is_function_util_1.isFunction(schema) ? schema(this) : schema;
            const components = services.get(core_1.OpenApi).getComponents(this);
            validateSchema = utils_1.getAjvInstance().compile(Object.assign(Object.assign({}, ajvSchema), { components }));
        }
        if (!validateSchema(ctx.request.body)) {
            return new core_1.HttpResponseBadRequest({ body: validateSchema.errors });
        }
    }
    const openapi = [
        core_1.ApiRequestBody((c) => ({
            content: {
                'application/json': {
                    schema: is_function_util_1.isFunction(schema) ? schema(c) : schema
                }
            },
            required: true
        })),
        core_1.ApiResponse(400, { description: 'Bad request.' })
    ];
    return core_1.Hook(validate, openapi, options);
}
exports.ValidateBody = ValidateBody;
